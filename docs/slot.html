<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>„Çπ„É≠„ÉÉ„Éà„Ç≤„Éº„É†</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{
  background:#0a0a12;
  color:#fff;
  font-family:'Segoe UI','Hiragino Sans',sans-serif;
  display:flex;justify-content:center;align-items:center;
  min-height:100vh;
  overflow-y:auto;
  position:relative;
}

/* „Éë„Éº„ÉÜ„Ç£„ÇØ„É´ËÉåÊôØ */
.particles{
  position:fixed;inset:0;pointer-events:none;z-index:0;
  overflow:hidden;
}
.particle{
  position:absolute;
  width:4px;height:4px;
  background:#ffd700;
  border-radius:50%;
  animation:float 8s infinite;
  opacity:0.3;
}
@keyframes float{
  0%,100%{transform:translateY(100vh) scale(0);opacity:0}
  10%{opacity:0.5}
  90%{opacity:0.5}
  100%{transform:translateY(-20vh) scale(1);opacity:0}
}

.machine{
  background:linear-gradient(160deg,#1a1a35 0%,#0d0d20 100%);
  border:4px solid transparent;
  border-image:linear-gradient(135deg,#ffd700,#ff6600,#ffd700) 1;
  border-radius:24px;
  padding:28px 24px 24px;
  box-shadow:
    0 0 60px rgba(255,215,0,.3),
    0 0 120px rgba(255,102,0,.15),
    inset 0 1px 0 rgba(255,255,255,.08);
  text-align:center;
  width:560px;max-width:97vw;
  position:relative;
  z-index:1;
}

.title{
  font-size:2.4em;font-weight:900;letter-spacing:.2em;
  background:linear-gradient(180deg,#ffe066 0%,#ffd700 50%,#ff8c00 100%);
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;
  text-shadow:0 0 30px rgba(255,215,0,.5);
  margin-bottom:4px;
  animation:titleGlow 2s ease-in-out infinite alternate;
}
@keyframes titleGlow{
  from{filter:drop-shadow(0 0 10px rgba(255,215,0,.5))}
  to{filter:drop-shadow(0 0 25px rgba(255,215,0,.8))}
}

.subtitle{font-size:.8em;color:#ff8c00;margin-bottom:16px;letter-spacing:.15em;text-transform:uppercase}

.info-bar{
  display:flex;justify-content:space-between;align-items:center;
  margin-bottom:18px;padding:0 4px;
}
.coin-box,.bet-box{
  font-size:1.1em;font-weight:700;
  padding:10px 22px;border-radius:12px;
  background:linear-gradient(180deg,rgba(30,30,60,.9),rgba(15,15,35,.95));
  border:2px solid #444;
  box-shadow:inset 0 2px 8px rgba(0,0,0,.5);
}
.coin-box span{color:#ffd700;text-shadow:0 0 10px rgba(255,215,0,.5)}
.bet-box span{color:#ff6600}
.coin-box.flash{animation:cpulse .4s}
@keyframes cpulse{50%{transform:scale(1.1);border-color:#ffd700;box-shadow:0 0 20px rgba(255,215,0,.6)}}

/* === Reels === */
.frame{
  background:linear-gradient(180deg,#000,#0a0a15);
  border:5px solid;
  border-image:linear-gradient(180deg,#666,#333,#666) 1;
  border-radius:16px;
  padding:0;margin-bottom:20px;position:relative;
  overflow:hidden;
  box-shadow:inset 0 0 50px rgba(0,0,0,.8);
}
.reels{
  display:flex;justify-content:center;gap:8px;
  padding:12px 10px;
}
.reel{
  width:140px;height:300px;
  overflow:hidden;position:relative;
  background:linear-gradient(180deg,#050510,#0a0a18,#050510);
  border:3px solid #555;border-radius:10px;
  box-shadow:inset 0 0 30px rgba(0,0,0,.9);
}
.reel-strip{position:absolute;width:100%;left:0;top:0;will-change:transform}
.sym{
  width:100%;height:100px;
  display:flex;align-items:center;justify-content:center;
  flex-direction:column;
  border-bottom:1px solid rgba(255,255,255,.05);
  user-select:none;position:relative;
}
.sym-icon{font-size:2.8em;line-height:1}
.sym-label{font-size:.6em;margin-top:3px;opacity:.7;letter-spacing:.05em;text-transform:uppercase}

/* symbol themes */
.s-cherry .sym-icon{color:#ff3366;text-shadow:0 0 15px rgba(255,51,102,.6)}
.s-bell   .sym-icon{color:#ffcc00;text-shadow:0 0 15px rgba(255,204,0,.6)}
.s-bar    .sym-icon{color:#fff;font-weight:900;font-size:1.9em;
  background:linear-gradient(180deg,#666,#222);padding:6px 16px;border-radius:8px;
  border:3px solid #888;box-shadow:0 0 15px rgba(255,255,255,.2)}
.s-anoken .sym-icon{color:#00ffff;font-weight:900;font-size:1.6em;
  background:linear-gradient(180deg,#0a3050,#051828);padding:6px 12px;border-radius:8px;
  border:3px solid #00aacc;box-shadow:0 0 20px rgba(0,255,255,.4);
  text-shadow:0 0 10px rgba(0,255,255,.8)}
.s-seven  .sym-icon{
  color:#ff0000;font-weight:900;font-size:3em;
  text-shadow:0 0 20px rgba(255,0,0,.8),0 0 40px rgba(255,0,0,.4);
  animation:sevenPulse 1s ease-in-out infinite alternate;
}
@keyframes sevenPulse{
  from{filter:brightness(1)}
  to{filter:brightness(1.3)}
}
.s-404 .sym-icon{
  color:#ff4444;font-weight:900;font-size:1.8em;
  background:linear-gradient(180deg,#440000,#220000);padding:6px 12px;border-radius:8px;
  border:3px solid #ff0000;box-shadow:0 0 20px rgba(255,0,0,.5);
  text-shadow:0 0 10px rgba(255,0,0,.8);
  animation:errorBlink 0.5s ease-in-out infinite;
}
@keyframes errorBlink{
  0%,100%{opacity:1}
  50%{opacity:0.7}
}

.sym.hl{animation:symhl .5s ease-in-out infinite alternate}
@keyframes symhl{from{background:rgba(255,215,0,.1)}to{background:rgba(255,215,0,.35);box-shadow:inset 0 0 30px rgba(255,215,0,.3)}}

/* reel overlays */
.reel-shade-t,.reel-shade-b{
  position:absolute;left:0;right:0;height:40px;pointer-events:none;z-index:3;
}
.reel-shade-t{top:0;background:linear-gradient(#050510,transparent)}
.reel-shade-b{bottom:0;background:linear-gradient(transparent,#050510)}
.reel-center{
  position:absolute;left:0;right:0;top:99px;height:102px;
  border-top:3px solid rgba(255,215,0,.5);
  border-bottom:3px solid rgba(255,215,0,.5);
  pointer-events:none;z-index:4;
  box-shadow:inset 0 0 20px rgba(255,215,0,.2);
}

/* win-lines SVG overlay */
.win-svg{
  position:absolute;top:12px;left:10px;
  width:calc(100% - 20px);height:300px;
  pointer-events:none;z-index:6;
}
.win-svg line{stroke-width:3;stroke-linecap:round;opacity:0;
  animation:lineFade .6s ease forwards}
@keyframes lineFade{to{opacity:.8}}

/* === Controls === */
.controls{display:flex;gap:12px;justify-content:center;margin-bottom:12px;flex-wrap:wrap}
button{
  font-family:inherit;padding:14px 26px;font-size:1.1em;font-weight:700;
  border:none;border-radius:12px;cursor:pointer;transition:all .2s;
  text-transform:uppercase;letter-spacing:.08em;
}
button:disabled{opacity:.3;cursor:not-allowed;transform:none!important;box-shadow:none!important}
.btn-start{
  background:linear-gradient(180deg,#44ff44,#22cc22,#22aa22);color:#000;
  min-width:220px;font-size:1.3em;
  box-shadow:0 0 30px rgba(68,255,68,.3);
  border:2px solid #66ff66;
}
.btn-start:hover:not(:disabled){transform:scale(1.06);box-shadow:0 0 40px rgba(68,255,68,.6)}
.btn-start:active:not(:disabled){transform:scale(.96)}
.btn-stop{
  background:linear-gradient(180deg,#ff4444,#cc2222,#aa2222);color:#fff;
  min-width:95px;
  box-shadow:0 0 20px rgba(255,68,68,.2);
  border:2px solid #ff6666;
}
.btn-stop:hover:not(:disabled){transform:scale(1.06);box-shadow:0 0 30px rgba(255,68,68,.5)}
.btn-stop:active:not(:disabled){transform:scale(.96)}

.result{
  min-height:52px;font-size:1.2em;padding:10px 12px;
  border-radius:12px;margin-bottom:16px;
  transition:all .3s;
  background:rgba(0,0,0,.3);
}
.result.win{
  color:#ffd700;
  background:linear-gradient(180deg,rgba(255,215,0,.15),rgba(255,150,0,.1));
  border:2px solid rgba(255,215,0,.4);
  text-shadow:0 0 12px rgba(255,215,0,.6);
  animation:winFlash .4s ease-in-out 4;
}
.result.big-win{
  font-size:1.6em;
  color:#ff3333;
  background:linear-gradient(180deg,rgba(255,50,50,.2),rgba(255,100,0,.15));
  border:2px solid rgba(255,50,50,.5);
  text-shadow:0 0 20px rgba(255,50,50,.7);
  animation:bigWinFlash .3s ease-in-out 6;
}
.result.jackpot{
  font-size:1.8em;
  color:#00ffff;
  background:linear-gradient(180deg,rgba(0,255,255,.2),rgba(0,150,200,.15));
  border:3px solid rgba(0,255,255,.6);
  text-shadow:0 0 25px rgba(0,255,255,.8);
  animation:jackpotFlash .2s ease-in-out 10;
}
@keyframes winFlash{0%,100%{opacity:1}50%{opacity:.5}}
@keyframes bigWinFlash{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.6;transform:scale(1.02)}}
@keyframes jackpotFlash{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.4;transform:scale(1.05)}}
.result small{font-size:.75em;opacity:.85}

/* paytable */
.paytable{
  background:linear-gradient(180deg,rgba(20,20,40,.8),rgba(10,10,25,.9));
  border-radius:12px;padding:14px 16px;
  border:1px solid #333;
  display:grid;grid-template-columns:1fr 1fr;gap:6px;
  font-size:.85em;text-align:left;
}
.pt-item{
  display:flex;justify-content:space-between;
  padding:6px 12px;border-radius:6px;
  background:rgba(255,255,255,.03);
  border:1px solid rgba(255,255,255,.05);
}
.pt-item span:last-child{color:#ffd700;font-weight:700;text-shadow:0 0 5px rgba(255,215,0,.3)}
.pt-item.special{background:rgba(0,255,255,.1);border-color:rgba(0,255,255,.3)}
.pt-item.error{background:rgba(255,0,0,.1);border-color:rgba(255,0,0,.3)}

.keys-hint{
  margin-top:12px;font-size:.72em;color:#666;letter-spacing:.03em;
}

/* Debug mode */
.debug-toggle{
  margin-top:8px;font-size:.65em;color:#444;
  cursor:pointer;user-select:none;
  transition:all .2s;
}
.debug-toggle:hover{color:#666}
.debug-toggle.on{
  color:#ff4444;
  text-shadow:0 0 5px rgba(255,68,68,.5);
}
.debug-indicator{
  display:none;
  position:absolute;top:8px;right:12px;
  font-size:.7em;color:#ff4444;
  background:rgba(255,0,0,.15);
  padding:4px 10px;border-radius:6px;
  border:1px solid rgba(255,0,0,.3);
  animation:debugBlink 1s infinite;
}
.debug-indicator.show{display:block}
@keyframes debugBlink{0%,100%{opacity:1}50%{opacity:.5}}

/* Game Over */
.overlay{
  display:none;position:fixed;inset:0;
  background:rgba(0,0,0,.9);z-index:100;
  justify-content:center;align-items:center;flex-direction:column;
}
.overlay.show{display:flex}
.overlay h2{font-size:3em;color:#ff4444;margin-bottom:20px;letter-spacing:.12em;
  text-shadow:0 0 30px rgba(255,68,68,.6)}
.overlay p{font-size:1.2em;margin-bottom:28px;color:#aaa}
.overlay button{
  background:linear-gradient(180deg,#ffd700,#ff9500,#c8a000);
  color:#000;font-size:1.25em;padding:16px 50px;border-radius:14px;
  border:3px solid #ffe066;cursor:pointer;font-weight:700;
  box-shadow:0 0 30px rgba(255,215,0,.4);
}
.overlay button:hover{transform:scale(1.08);box-shadow:0 0 50px rgba(255,215,0,.6)}

/* 404 Error Page */
.error-overlay{
  display:none;position:fixed;inset:0;
  background:#000;z-index:200;
  justify-content:center;align-items:center;flex-direction:column;
  animation:staticNoise 0.1s infinite;
}
.error-overlay.show{display:flex}
@keyframes staticNoise{
  0%{background-color:#000}
  25%{background-color:#0a0a0a}
  50%{background-color:#050505}
  75%{background-color:#0f0f0f}
}
.error-overlay h1{
  font-size:8em;color:#ff0000;margin-bottom:20px;
  text-shadow:0 0 50px rgba(255,0,0,.8),0 0 100px rgba(255,0,0,.4);
  animation:glitch 0.3s infinite;
}
@keyframes glitch{
  0%{transform:translate(0)}
  20%{transform:translate(-3px,3px)}
  40%{transform:translate(3px,-3px)}
  60%{transform:translate(-3px,-3px)}
  80%{transform:translate(3px,3px)}
  100%{transform:translate(0)}
}
.error-overlay h2{font-size:2em;color:#ff4444;margin-bottom:30px;letter-spacing:.3em}
.error-overlay p{font-size:1.1em;color:#888;margin-bottom:40px}
.error-overlay button{
  background:linear-gradient(180deg,#ff4444,#aa0000);
  color:#fff;font-size:1.2em;padding:16px 50px;border-radius:14px;
  border:3px solid #ff6666;cursor:pointer;font-weight:700;
}

/* Jackpot overlay */
.jackpot-overlay{
  display:none;position:fixed;inset:0;
  background:rgba(0,50,80,.95);z-index:150;
  justify-content:center;align-items:center;flex-direction:column;
}
.jackpot-overlay.show{display:flex;animation:jackpotBg 0.5s ease}
@keyframes jackpotBg{from{opacity:0}to{opacity:1}}
.jackpot-overlay h1{
  font-size:4em;color:#00ffff;margin-bottom:10px;
  text-shadow:0 0 40px rgba(0,255,255,.9);
  animation:jackpotText 0.5s ease-in-out infinite alternate;
}
@keyframes jackpotText{from{transform:scale(1)}to{transform:scale(1.05)}}
.jackpot-overlay h2{font-size:2.5em;color:#ffd700;margin-bottom:20px;
  text-shadow:0 0 30px rgba(255,215,0,.7)}
.jackpot-overlay p{font-size:1.4em;color:#fff;margin-bottom:30px}
.jackpot-overlay button{
  background:linear-gradient(180deg,#00ffff,#0088aa);
  color:#000;font-size:1.3em;padding:18px 60px;border-radius:14px;
  border:3px solid #66ffff;cursor:pointer;font-weight:700;
  box-shadow:0 0 40px rgba(0,255,255,.5);
}

@media(max-width:540px){
  .machine{padding:18px 12px 16px}
  .title{font-size:1.7em}
  .reel{width:105px;height:240px}
  .sym{height:80px}
  .sym-icon{font-size:2.1em}
  .reel-center{top:79px;height:82px}
  .reel-shade-t,.reel-shade-b{height:28px}
  .btn-start{min-width:170px;font-size:1.15em}
  .btn-stop{min-width:75px;font-size:1em}
}
</style>
</head>
<body>

<!-- „Éë„Éº„ÉÜ„Ç£„ÇØ„É´ËÉåÊôØ -->
<div class="particles" id="particles"></div>

<div class="machine">
  <div class="title">‚òÖ SLOT GAME ‚òÖ</div>
  <div class="subtitle">~ CYBER CASINO ~</div>

  <div class="info-bar">
    <div class="coin-box" id="coin-box">ü™ô „Ç≥„Ç§„É≥: <span id="coins">100</span></div>
    <div class="bet-box">BET: <span>3</span></div>
  </div>

  <div class="frame" id="frame">
    <div class="reels" id="reels">
      <div class="reel" id="reel-0">
        <div class="reel-strip" id="strip-0"></div>
        <div class="reel-shade-t"></div>
        <div class="reel-shade-b"></div>
        <div class="reel-center"></div>
      </div>
      <div class="reel" id="reel-1">
        <div class="reel-strip" id="strip-1"></div>
        <div class="reel-shade-t"></div>
        <div class="reel-shade-b"></div>
        <div class="reel-center"></div>
      </div>
      <div class="reel" id="reel-2">
        <div class="reel-strip" id="strip-2"></div>
        <div class="reel-shade-t"></div>
        <div class="reel-shade-b"></div>
        <div class="reel-center"></div>
      </div>
    </div>
    <svg class="win-svg" id="win-svg" preserveAspectRatio="none"></svg>
  </div>

  <div class="controls">
    <button class="btn-start" id="btn-start">üé∞ „Çπ„Çø„Éº„Éà</button>
  </div>
  <div class="controls" style="margin-bottom:16px">
    <button class="btn-stop" id="stop-0" disabled>STOP 1</button>
    <button class="btn-stop" id="stop-1" disabled>STOP 2</button>
    <button class="btn-stop" id="stop-2" disabled>STOP 3</button>
  </div>

  <div class="result" id="result"></div>

  <div class="paytable">
    <div class="pt-item"><span style="color:#ff3366">üçí „ÉÅ„Çß„É™„Éº √ó3</span><span>+5</span></div>
    <div class="pt-item"><span style="color:#ffcc00">üîî „Éô„É´ √ó3</span><span>+10</span></div>
    <div class="pt-item"><span>BAR √ó3</span><span>+20</span></div>
    <div class="pt-item special"><span style="color:#00ffff">aNoÁ†î √ó3</span><span>4ÂÑÑÊûö!</span></div>
    <div class="pt-item"><span style="color:#ff2222">7 √ó3</span><span>+100</span></div>
    <div class="pt-item error"><span style="color:#ff4444">404 √ó3</span><span>ERROR!</span></div>
    <div class="pt-item"><span>Âà§ÂÆö„É©„Ç§„É≥</span><span>5Êú¨</span></div>
  </div>

  <div class="keys-hint">SPACE=„Çπ„Çø„Éº„Éà / 1,2,3=„Çπ„Éà„ÉÉ„Éó / üîäÂäπÊûúÈü≥‰ªò„Åç</div>
  <div class="debug-toggle" id="debug-toggle">„Éá„Éê„ÉÉ„Ç∞„É¢„Éº„Éâ: OFF</div>
  <div class="debug-indicator" id="debug-indicator">DEBUG MODE</div>
</div>

<div class="overlay" id="overlay-gameover">
  <h2>GAME OVER</h2>
  <p>„Ç≥„Ç§„É≥„Åå„Å™„Åè„Å™„Çä„Åæ„Åó„Åü</p>
  <button id="btn-restart">üîÑ „É™„Çπ„Çø„Éº„Éà</button>
</div>

<div class="error-overlay" id="overlay-error">
  <h1>404</h1>
  <h2>PAGE NOT FOUND</h2>
  <p>„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü... „Çπ„É≠„ÉÉ„Éà„ÅÆÂë™„ÅÑ!?</p>
  <button id="btn-error-close">„Ç≤„Éº„É†„Å´Êàª„Çã</button>
</div>

<div class="jackpot-overlay" id="overlay-jackpot">
  <h1>üéä JACKPOT! üéä</h1>
  <h2>aNoÁ†î √ó3</h2>
  <p>4ÂÑÑÊûöÁç≤Âæó! „Åä„ÇÅ„Åß„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„Åô!</p>
  <button id="btn-jackpot-go">aNoÁ†î„Çµ„Ç§„Éà„Å∏GO!</button>
</div>

<script>
/* ====== Sound Effects (Web Audio API) ====== */
const AudioCtx = window.AudioContext || window.webkitAudioContext;
let audioCtx = null;

function initAudio() {
  if (!audioCtx) audioCtx = new AudioCtx();
}

function playSound(type) {
  initAudio();
  if (!audioCtx) return;

  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();
  osc.connect(gain);
  gain.connect(audioCtx.destination);

  const now = audioCtx.currentTime;

  switch(type) {
    case 'spin':
      osc.type = 'square';
      osc.frequency.setValueAtTime(200, now);
      osc.frequency.exponentialRampToValueAtTime(800, now + 0.1);
      gain.gain.setValueAtTime(0.15, now);
      gain.gain.exponentialRampToValueAtTime(0.01, now + 0.15);
      osc.start(now);
      osc.stop(now + 0.15);
      break;
    case 'stop':
      osc.type = 'sine';
      osc.frequency.setValueAtTime(600, now);
      osc.frequency.exponentialRampToValueAtTime(200, now + 0.1);
      gain.gain.setValueAtTime(0.2, now);
      gain.gain.exponentialRampToValueAtTime(0.01, now + 0.12);
      osc.start(now);
      osc.stop(now + 0.12);
      break;
    case 'win':
      osc.type = 'sine';
      osc.frequency.setValueAtTime(523, now);
      gain.gain.setValueAtTime(0.2, now);
      osc.frequency.setValueAtTime(659, now + 0.1);
      osc.frequency.setValueAtTime(784, now + 0.2);
      osc.frequency.setValueAtTime(1047, now + 0.3);
      gain.gain.exponentialRampToValueAtTime(0.01, now + 0.5);
      osc.start(now);
      osc.stop(now + 0.5);
      break;
    case 'bigwin':
      for (let i = 0; i < 3; i++) {
        const o = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        o.connect(g);
        g.connect(audioCtx.destination);
        o.type = 'sine';
        const t = now + i * 0.15;
        o.frequency.setValueAtTime(523 * (i + 1), t);
        o.frequency.exponentialRampToValueAtTime(1047 * (i + 1), t + 0.2);
        g.gain.setValueAtTime(0.15, t);
        g.gain.exponentialRampToValueAtTime(0.01, t + 0.3);
        o.start(t);
        o.stop(t + 0.3);
      }
      break;
    case 'jackpot':
      for (let i = 0; i < 8; i++) {
        const o = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        o.connect(g);
        g.connect(audioCtx.destination);
        o.type = 'sine';
        const t = now + i * 0.1;
        o.frequency.setValueAtTime(440 + i * 100, t);
        g.gain.setValueAtTime(0.2, t);
        g.gain.exponentialRampToValueAtTime(0.01, t + 0.15);
        o.start(t);
        o.stop(t + 0.15);
      }
      break;
    case 'error':
      osc.type = 'sawtooth';
      osc.frequency.setValueAtTime(100, now);
      osc.frequency.linearRampToValueAtTime(50, now + 0.5);
      gain.gain.setValueAtTime(0.3, now);
      gain.gain.linearRampToValueAtTime(0.01, now + 0.5);
      osc.start(now);
      osc.stop(now + 0.5);
      break;
    case 'lose':
      osc.type = 'sine';
      osc.frequency.setValueAtTime(400, now);
      osc.frequency.exponentialRampToValueAtTime(100, now + 0.3);
      gain.gain.setValueAtTime(0.1, now);
      gain.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
      osc.start(now);
      osc.stop(now + 0.3);
      break;
  }
}

/* ====== Particles ====== */
function createParticles() {
  const container = document.getElementById('particles');
  for (let i = 0; i < 30; i++) {
    const p = document.createElement('div');
    p.className = 'particle';
    p.style.left = Math.random() * 100 + '%';
    p.style.animationDelay = Math.random() * 8 + 's';
    p.style.animationDuration = (6 + Math.random() * 4) + 's';
    if (Math.random() > 0.5) p.style.background = '#ff6600';
    container.appendChild(p);
  }
}

/* ====== Constants ====== */
const SYM_DATA = {
  cherry:{id:'cherry',icon:'üçí',  label:'„ÉÅ„Çß„É™„Éº',cls:'s-cherry',payout:5},
  bell:  {id:'bell',  icon:'üîî',  label:'„Éô„É´',    cls:'s-bell',  payout:10},
  bar:   {id:'bar',   icon:'BAR', label:'BAR',     cls:'s-bar',   payout:20},
  anoken:{id:'anoken',icon:'aNoÁ†î',label:'aNoÁ†î',  cls:'s-anoken',payout:400000000},
  seven: {id:'seven', icon:'Ôºó',   label:'7',       cls:'s-seven', payout:100},
  e404:  {id:'e404',  icon:'404', label:'ERROR',   cls:'s-404',   payout:-1},
};

/* 18-symbol reel strip (404ËøΩÂä†)
   cherry√ó5  bell√ó4  bar√ó3  anoken√ó2  seven√ó1  404√ó3 */
const STRIP = [
  'cherry','bell','bar','cherry','bell','anoken',
  'cherry','bar','e404','bell','cherry','seven',
  'e404','bar','bell','anoken','cherry','e404'
];

const SH = 100;
const RLEN = STRIP.length;
const CYCLES = 5;
const BET = 3;
const INIT_COINS = 100;
const STOP_DUR = 450;
const AUTOSTOP = 15000;

/* ====== State ====== */
let coins = INIT_COINS;
let reels = [];
let stoppedN = 0;
let playing = false;
let debugMode = false;
let debugSymbol = 'seven'; // „Éá„Éê„ÉÉ„Ç∞ÊôÇ„Å´ÊèÉ„Åà„Çã„Ç∑„É≥„Éú„É´
const DEBUG_SYMBOLS = ['cherry','bell','bar','anoken','seven','e404']; // ÂÖ®„Ç∑„É≥„Éú„É´

/* ====== Reel class ====== */
class Reel {
  constructor(i){
    this.idx = i;
    this.el = document.getElementById(`reel-${i}`);
    this.stripEl = document.getElementById(`strip-${i}`);
    this.spinning = false;
    this.stopping = false;
    this.speed = 0;
    this.lastT = 0;
    this.stopT0 = 0;
    this.stopP0 = 0;
    this.stopTarget = 0;
    this.raf = null;
    this.autoTimer = null;
    this.onStop = null;
    this._build();
    const sh = this._sh();
    const startIdx = Math.floor(Math.random()*RLEN);
    this.pos = startIdx * sh;
    this.offset = startIdx;
    this._render();
  }

  _build(){
    let h='';
    for(let c=0;c<CYCLES;c++){
      for(let j=0;j<RLEN;j++){
        const s=SYM_DATA[STRIP[j]];
        h+=`<div class="sym ${s.cls}" data-sid="${s.id}">
              <div class="sym-icon">${s.icon}</div>
              <div class="sym-label">${s.label}</div>
            </div>`;
      }
    }
    this.stripEl.innerHTML=h;
    this.symEls = this.stripEl.querySelectorAll('.sym');
  }

  _render(){
    this.stripEl.style.transform=`translateY(${-this.pos}px)`;
  }

  _sh(){
    if(this.symEls.length) return this.symEls[0].offsetHeight || SH;
    return SH;
  }

  spin(){
    if(this.raf) cancelAnimationFrame(this.raf);
    if(this.autoTimer) clearTimeout(this.autoTimer);
    this.spinning=true;
    this.stopping=false;
    const sh=this._sh();
    this.speed = (14+Math.random()*4) * (sh/SH);
    this.lastT=performance.now();
    this.clearHL();
    this._loop();
    this.autoTimer=setTimeout(()=>{if(this.spinning)this.stop();},AUTOSTOP);
  }

  _loop(){
    const now=performance.now();
    const sh=this._sh();
    const cyclePx=RLEN*sh;

    if(this.stopping){
      const elapsed=now-this.stopT0;
      const prog=Math.min(elapsed/STOP_DUR,1);
      const ease=1-Math.pow(1-prog,3);
      this.pos=this.stopP0+(this.stopTarget-this.stopP0)*ease;
      this._render();
      if(prog>=1){
        this.pos=this.stopTarget;
        while(this.pos>=cyclePx) this.pos-=cyclePx;
        while(this.pos<0) this.pos+=cyclePx;
        this.offset=Math.round(this.pos/sh)%RLEN;
        this._render();
        this.stopping=false;
        if(this.onStop) this.onStop();
        return;
      }
    } else if(this.spinning){
      const dt=Math.min(now-this.lastT,50);
      this.lastT=now;
      this.pos+=this.speed*(dt/16.67);
      while(this.pos>=cyclePx*(CYCLES-1)) this.pos-=cyclePx;
      this._render();
    }
    this.raf=requestAnimationFrame(()=>this._loop());
  }

  stop(){
    if(!this.spinning) return;
    if(this.autoTimer){clearTimeout(this.autoTimer);this.autoTimer=null;}
    this.spinning=false;
    this.stopping=true;
    this.stopP0=this.pos;
    this.stopT0=performance.now();
    const sh=this._sh();

    if(debugMode){
      // „Éá„Éê„ÉÉ„Ç∞„É¢„Éº„Éâ: ÊåáÂÆö„Ç∑„É≥„Éú„É´„Åå‰∏≠ÊÆµ(row=1)„Å´Êù•„Çã„Çà„ÅÜ„Å´ÂÅúÊ≠¢
      const targetIdx = STRIP.indexOf(debugSymbol);
      if(targetIdx !== -1){
        // ‰∏≠ÊÆµ„Å´Êù•„Çã„Å´„ÅØ„ÄÅoffset„ÅåtargetIdx-1„Å´„Å™„Çå„Å∞„Çà„ÅÑ
        const desiredOffset = (targetIdx - 1 + RLEN) % RLEN;
        this.stopTarget = desiredOffset * sh;
        // ÁèæÂú®‰ΩçÁΩÆ„Åã„ÇâÊúÄÁü≠„ÅßÂà∞ÈÅî„Åô„Çã„Çà„ÅÜË™øÊï¥
        const cyclePx = RLEN * sh;
        while(this.stopTarget < this.stopP0) this.stopTarget += cyclePx;
      }
    } else {
      const ahead=2.5*sh;
      this.stopTarget=Math.round((this.pos+ahead)/sh)*sh;
    }
    playSound('stop');
  }

  getSymbols(){
    const o=this.offset;
    return [
      STRIP[o%RLEN],
      STRIP[(o+1)%RLEN],
      STRIP[(o+2)%RLEN]
    ];
  }

  clearHL(){
    this.symEls.forEach(e=>e.classList.remove('hl'));
  }

  highlight(row){
    const sh=this._sh();
    const i=this.offset+row;
    const el=this.symEls[i%this.symEls.length];
    if(el) el.classList.add('hl');
  }
}

/* ====== Init ====== */
function init(){
  createParticles();
  reels=[new Reel(0),new Reel(1),new Reel(2)];
  reels.forEach(r=>{
    r.onStop=()=>{
      stoppedN++;
      if(stoppedN===3) evaluate();
    };
  });
  updateCoins();
  document.getElementById('btn-start').addEventListener('click',startGame);
  document.getElementById('btn-restart').addEventListener('click',resetGame);
  document.getElementById('btn-error-close').addEventListener('click',closeError);
  document.getElementById('btn-jackpot-go').addEventListener('click',goToAnoken);
  document.getElementById('debug-toggle').addEventListener('click',toggleDebug);
  for(let i=0;i<3;i++){
    document.getElementById(`stop-${i}`).addEventListener('click',()=>stopReel(i));
  }
  document.addEventListener('keydown',onKey);
}

/* ====== Debug Mode ====== */
function toggleDebug(){
  debugMode = !debugMode;
  const toggle = document.getElementById('debug-toggle');
  const indicator = document.getElementById('debug-indicator');
  if(debugMode){
    toggle.textContent = '„Éá„Éê„ÉÉ„Ç∞„É¢„Éº„Éâ: ON (ÊØéÂõû„É©„É≥„ÉÄ„É†)';
    toggle.classList.add('on');
    indicator.classList.add('show');
  } else {
    toggle.textContent = '„Éá„Éê„ÉÉ„Ç∞„É¢„Éº„Éâ: OFF';
    toggle.classList.remove('on');
    indicator.classList.remove('show');
  }
}

/* ====== Game flow ====== */
function startGame(){
  if(playing) return;
  if(coins<BET){showGameOver();return;}
  coins-=BET;
  updateCoins();
  playing=true;
  stoppedN=0;
  clearResult();
  clearWinLines();
  reels.forEach(r=>r.clearHL());
  setBtnStart(false);
  setStopBtns(true);

  // „Éá„Éê„ÉÉ„Ç∞„É¢„Éº„Éâ: ÊØéÂõû„É©„É≥„ÉÄ„É†„Å´„Ç∑„É≥„Éú„É´„ÇíÈÅ∏„Å∂
  if(debugMode){
    debugSymbol = DEBUG_SYMBOLS[Math.floor(Math.random() * DEBUG_SYMBOLS.length)];
    const symName = SYM_DATA[debugSymbol].label;
    document.getElementById('debug-toggle').textContent = `„Éá„Éê„ÉÉ„Ç∞„É¢„Éº„Éâ: ON (${symName}„ÅßÊèÉ„ÅÜ)`;
  }

  playSound('spin');
  reels.forEach(r=>r.spin());
}

function stopReel(i){
  if(!playing) return;
  const btn=document.getElementById(`stop-${i}`);
  if(btn.disabled) return;
  btn.disabled=true;
  reels[i].stop();
}

function evaluate(){
  const g=reels.map(r=>r.getSymbols());

  const LINES=[
    {name:'‰∏äÊÆµ',    ps:[[0,0],[1,0],[2,0]], color:'#ff4444'},
    {name:'‰∏≠ÊÆµ',    ps:[[0,1],[1,1],[2,1]], color:'#44ff44'},
    {name:'‰∏ãÊÆµ',    ps:[[0,2],[1,2],[2,2]], color:'#4488ff'},
    {name:'Êñú„ÇÅ‚Üò',  ps:[[0,0],[1,1],[2,2]], color:'#ffaa00'},
    {name:'Êñú„ÇÅ‚Üó',  ps:[[0,2],[1,1],[2,0]], color:'#cc44ff'},
  ];

  let total=0;
  const wins=[];
  let hasAnoken = false;
  let has404 = false;

  LINES.forEach(L=>{
    const ids=L.ps.map(([r,row])=>g[r][row]);
    if(ids[0]===ids[1]&&ids[1]===ids[2]){
      const s=SYM_DATA[ids[0]];
      if(ids[0] === 'anoken') {
        hasAnoken = true;
      } else if(ids[0] === 'e404') {
        has404 = true;
      } else {
        total+=s.payout;
      }
      wins.push({...L,sym:s});
      L.ps.forEach(([r,row])=>reels[r].highlight(row));
    }
  });

  // 404„ÅåÊèÉ„Å£„ÅüÂ†¥Âêà - „Ç®„É©„Éº„Éö„Éº„Ç∏Ë°®Á§∫
  if(has404){
    playSound('error');
    drawWinLines(wins);
    setTimeout(()=>{
      document.getElementById('overlay-error').classList.add('show');
    }, 800);
    playing=false;
    if(coins>=BET) setBtnStart(true);
    return;
  }

  // aNoÁ†î„ÅåÊèÉ„Å£„ÅüÂ†¥Âêà - 4ÂÑÑÊûö & „É™„É≥„ÇØ
  if(hasAnoken){
    coins = 400000000;
    updateCoins();
    playSound('jackpot');
    drawWinLines(wins);
    showResult(
      'üéä JACKPOT! aNoÁ†î √ó3 üéä',
      '4ÂÑÑÊûöÁç≤Âæó! aNoÁ†î„Çµ„Ç§„Éà„Å∏ÁßªÂãï„Åó„Åæ„Åô!',
      'jackpot'
    );
    setTimeout(()=>{
      document.getElementById('overlay-jackpot').classList.add('show');
    }, 1500);
    playing=false;
    setBtnStart(true);
    return;
  }

  if(total>0){
    coins+=total;
    updateCoins();
    drawWinLines(wins);
    const det=wins.map(w=>`${w.name}: ${w.sym.icon} ${w.sym.label}`).join(' / ');
    const big=total>=50;
    if(big) playSound('bigwin');
    else playSound('win');
    showResult(
      `üéâ WIN! +${total}Êûö`,
      det,
      big?'big-win':'win'
    );
  } else {
    playSound('lose');
    showResult('„Éè„Ç∫„É¨...','','');
  }

  playing=false;
  if(coins>=BET) setBtnStart(true);
  else setTimeout(showGameOver,1200);
}

/* ====== UI helpers ====== */
function updateCoins(){
  const display = coins >= 100000000 ? (coins/100000000).toFixed(1) + 'ÂÑÑ' : coins.toLocaleString();
  document.getElementById('coins').textContent=display;
  const box=document.getElementById('coin-box');
  box.classList.remove('flash');
  void box.offsetWidth;
  box.classList.add('flash');
}

function setBtnStart(en){document.getElementById('btn-start').disabled=!en;}
function setStopBtns(en){
  for(let i=0;i<3;i++) document.getElementById(`stop-${i}`).disabled=!en;
}

function showResult(main,sub,cls){
  const el=document.getElementById('result');
  el.innerHTML=main+(sub?`<br><small>${sub}</small>`:'');
  el.className='result'+(cls?' '+cls:'');
}
function clearResult(){
  const el=document.getElementById('result');
  el.textContent='';el.className='result';
}

function showGameOver(){
  playSound('error');
  document.getElementById('overlay-gameover').classList.add('show');
}
function resetGame(){
  coins=INIT_COINS;updateCoins();
  document.getElementById('overlay-gameover').classList.remove('show');
  setBtnStart(true);setStopBtns(false);
  clearResult();clearWinLines();
  reels.forEach(r=>r.clearHL());
  playing=false;
}

function closeError(){
  document.getElementById('overlay-error').classList.remove('show');
}

function goToAnoken(){
  window.location.href = 'https://anoken.jimdo.com';
}

/* ====== Win line drawing ====== */
function clearWinLines(){document.getElementById('win-svg').innerHTML='';}

function drawWinLines(wins){
  const svg=document.getElementById('win-svg');
  svg.innerHTML='';
  const reelEls=[
    document.getElementById('reel-0'),
    document.getElementById('reel-1'),
    document.getElementById('reel-2')
  ];

  const svgRect=svg.getBoundingClientRect();
  const w=svgRect.width, h=svgRect.height;
  svg.setAttribute('viewBox',`0 0 ${w} ${h}`);

  function cellCenter(ri,row){
    const rr=reelEls[ri].getBoundingClientRect();
    const sh=rr.height/3;
    return {
      x: rr.left+rr.width/2  - svgRect.left,
      y: rr.top +sh*row+sh/2 - svgRect.top
    };
  }

  wins.forEach(w=>{
    const pts=w.ps.map(([r,row])=>cellCenter(r,row));
    const ns='http://www.w3.org/2000/svg';
    const line1=document.createElementNS(ns,'polyline');
    line1.setAttribute('points',pts.map(p=>`${p.x},${p.y}`).join(' '));
    line1.setAttribute('fill','none');
    line1.setAttribute('stroke',w.color);
    line1.setAttribute('stroke-width','5');
    line1.setAttribute('stroke-linecap','round');
    line1.setAttribute('stroke-linejoin','round');
    line1.style.filter=`drop-shadow(0 0 10px ${w.color})`;
    svg.appendChild(line1);

    pts.forEach(p=>{
      const c=document.createElementNS(ns,'circle');
      c.setAttribute('cx',p.x);c.setAttribute('cy',p.y);c.setAttribute('r','8');
      c.setAttribute('fill',w.color);c.style.opacity='0.8';
      c.style.filter=`drop-shadow(0 0 5px ${w.color})`;
      svg.appendChild(c);
    });
  });
}

/* ====== Keyboard ====== */
function onKey(e){
  if(e.repeat) return;
  if(e.code==='Space'){e.preventDefault();if(!playing)startGame();}
  if(e.code==='Digit1'||e.code==='Numpad1'||e.code==='KeyJ') stopReel(0);
  if(e.code==='Digit2'||e.code==='Numpad2'||e.code==='KeyK') stopReel(1);
  if(e.code==='Digit3'||e.code==='Numpad3'||e.code==='KeyL') stopReel(2);
}

/* ====== Boot ====== */
init();
</script>
</body>
</html>
